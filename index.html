<?php
	/*
	Created by Rutuja Jori to display list of roles on 17-10-2020 for STAR-343
	*/

	// session_start();
	$today=date('Y-m-d');
	$frdate = date('Y-m-d', strtotime('-1 month'));

	include_once("conn.php");

	if(!isset($_SESSION['uname']))
	{
		header("Location:login.php");
	}

	include("class/pagination_new.php");

	$page = (int) (!isset($_GET["page"]) ? 1 : $_GET["page"]);
	$limit =10;
	$startpoint = ($page * $limit) - $limit;

	$sql="SELECT p.project_name,p.id,r.id as role_id,r.project_id,r.role_title FROM tbl_role_master r 
	LEFT JOIN tbl_project_master p ON p.id=r.project_id WHERE r.id!=''"; 

	if(isset($_POST['submit']) || isset($_SESSION['role_submit']))
	{
		$_SESSION['role_submit']=1;
    	$condition = "";

    	$_SESSION['projectrole'] = isset($_POST['project']) ? $_POST['project'] : $_SESSION['projectrole'];
	
		if($_SESSION['projectrole']!='')
		{
			$condition .="and r.project_id='".$_SESSION['projectrole']."'";
		}
	
		$sql="SELECT p.project_name,p.id,r.id as role_id,r.project_id,r.role_title FROM tbl_role_master r 
		LEFT JOIN tbl_project_master p ON p.id=r.project_id WHERE r.id!='' $condition"; 
	}

 	if(isset($_POST['reset']))
	{	
   		// session_destroy();
  		unset($_SESSION['role_submit']);
  		unset($_SESSION['projectrole']);
 
   		header("Location: list_roles.php"); 
	}

	$cond=$sql;
 	$totalrecords=mysql_num_rows(mysql_query($sql));

	if($totalrecords == 0)
	{
		$totalrecords = 0;
	}

	$sql.=" LIMIT {$startpoint} , {$limit}";
	$query=mysql_query($sql);

	// include_once("frm_header_record8.php"); 
	include_once("staff_header.php"); 

?>
<!--Design changes added by Chaitali on 17-12-2020-->
<!-- Remove following Code from frm_header_recored8 for page name  -->

<div class="grid_16 margin">
    <div id="tabmenuback2" style=" margin-top:5px; height:50px;"></div>
    <div class="bigtitle">
        <h1 style="margin-top:10px;">Roles List</h1>
    </div>
</div>
<!-- Clear -->
<div class="clear margin5"></div>
<!-- Blog List -->
<div class="grid_16 blog-list margin">
	<div class="bloglisting2"></div>
    <!-- Clear -->
    <div class="clear"></div>

	<!-- Ended Removal Code -->
    <!-- <head> -->

	<link href="css/pagination.css" rel="stylesheet" type="text/css" />
  	<link href="css/grey.css" rel="stylesheet" type="text/css" />
	<script language="javascript1.1" src="js/jquery-1.3.js"></script>
 	<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>

	<script src="js/jquery-ui.min.js"></script>

	<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

	<script src='https://kit.fontawesome.com/a076d05399.js'></script>

	<style type="text/css">

		.justify-content-center 
		{
    		-ms-flex-pack: center!important;
    		justify-content: center!important;
		}

		.row 
		{
    		display: -ms-flexbox;
    		display: flex;
    		-ms-flex-wrap: wrap;
    		flex-wrap: wrap;
    		margin-right: -15px;
    		margin-left: -15px;
		}

		table
		{
			font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,
			"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";    
		}

		table > thead > tr > th
		{	
			text-align:center;
			background-color:#17a2b8;
			color:white;
			font-weight: bold;
			font-size:16px;	
		}

		table > tbody 
		{
			border : 1px solid #17a2b8;
		}

		table > tbody > tr > td
		{	
			text-align:center;
			font-size:15px;
		}

		ul.pagination li.details 
		{
			color: #747272;
		}

		ul.pagination li a
		{
			padding:7px;
		}

	</style>

	<!-- </head> -->
	<!-- <body> -->

	<div style="margin-top: -145px">
		<br>
		<div class="row justify-content-center" >
			<div class="col-sm-10" style="background-color:white;">
				<br>
				<div class="row justify-content-center col-sm-12" >
					<form name="project" id="project" method="post" action="" class="form-inline" style="font-size:13px;">

						<div class="frm-group form-group">
           					<label class="p-2"><b>Project Name :</b></label>
           					<!--isenabled condition added by Rutuja for STAR-451 on 29-01-2021-->
							<?php $proType=mysql_query("SELECT id,project_name FROM tbl_project_master where isenabled='1'"); ?>
            			
							<select name="project" id="project" class="smartsearch form-control" style="width: 200px;">
            					<option value="">Select Project Name</option>
              					<?php
			  						while($r=mysql_fetch_array($proType))
			  						{
			  							?>
			  							<option value="<?php echo $r['id'];?>" 
										<?php if($_SESSION['projectrole']== $r['id']){?> selected="selected" <?php }?>>
											<?php echo $r['project_name'];?>
										</option>
             							<?php
              						}
			  					?>
              				</select>

							<input type="submit" name="submit" id="submit" value="Submit" class="btn btn-primary" />
							<input type="submit" class="btn btn-danger" value="Reset" name="reset" id="reset" />

						</div>

					</form>
				</div>				  
				<br><br>						
				<div class="col-sm-12" style="'Mate SC', serif;">
					
					<span class="btn" style="cursor: context-menu;"><b>Total Roles :</b></span>
					<span class="btn" style="border:1px solid grey; cursor: context-menu;">
						<?php echo $totalrecords;?>
					</span>
						
    	
    				<div style="float:right;">
						<a href="add_roles.php">
							<button class="btn btn-success" style="color:white;">Add Roles</button>
						</a> 
					</div>
  					
					<br><br>
				</div>
				
				<div class="col-sm-12 table-responsive"> 
				<table class="table" id="exp">
            		<thead>   	
						<tr>
							<th style="border-radius: 20px 0px 0px 0px;">Sr. No.</th>
							<?php 
								if(!isset($_POST['submit']))
								{ 
									?>
            						<th>Project Name</th>
									<?php 
								} 
							?>
            				<th>Role Title</th>
            				<th>Edit</th>
            				<th style="border-radius: 0px 20px 0px 0px;">Delete</th>
						</tr>
					</thead> 

					<tbody>
						<?php
							if($totalrecords>0)
							{ 	
								$i=1;
								$i=($startpoint+$i);

								while($row=mysql_fetch_array($query))
								{
									?>
									<tr>  
										<td><?php echo $i++; ?></td>
										<?php 
											if(!isset($_POST['submit']))
											{ 
												?>
												<td><?php echo $row['project_name']; ?></td>
												<?php 
											} 
										?>
										<td><?php echo $row['role_title']; ?></td>
										<td>
											<a href="add_roles.php?id=<?php echo $row['role_id']; ?>">
												<i class='fas fa-pencil-alt' style='font-size:16px; color:black;'></i>
											</a>
										</td>
			
										<!--Updated by Rutuja for adding 'role name' while deleting for STAR-389 on 20-11-2020-->
										<td>
											<a onClick="return confirm('Are you sure to delete record?');" href="delete_roles.php?id=<?php echo $row['role_id']; ?>&role_name=<?php echo $row['role_title']; ?>" class="ask">
												<i class="fas fa-trash-alt" style='font-size:16px; color:black;'></i>
											</a>
										</td>
									</tr>
									<?php
								}
							} 
							else
							{
								echo "<tr><td colspan='7' class='text-center'>No record found.</td></tr>";
							}
						?>
					</tbody>
				</table>
				</div>

				<div class="col-sm-12 pagination">
					<?php if(empty($_POST['search'])){ echo pagination_new($cond,$limit,$page); } ?>
  				</div> 

			</div>
		</div>
	 
	</div> 

	<!-- </body> -->
	<br/><br/>

	<script>
		 
		$(document).ready(function() {
			$(".datepicker").datepicker({
				changeMonth: true,
    			changeYear: true
			});

			$('.smartsearch').select2();

 	 	});
  
  	</script>
  
  	<div class="margin2"></div>	

	<?php include_once("footer.php");?>